<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Annotation Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tooltip {
            position: relative;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 140px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -70px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .label-btn {
            transition: all 0.2s ease;
        }
        .label-btn:checked + .label-text {
            font-weight: bold;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen font-sans">
    <div class="bg-white p-8 rounded-xl shadow-xl w-full max-w-3xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Data Annotation Platform</h1>

        <!-- CSV Upload -->
        <div class="mb-6">
            <label for="csvUpload" class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File:</label>
            <input type="file" id="csvUpload" accept="text/csv,.csv" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <p id="uploadStatus" class="text-sm text-gray-600 mt-2">Select a CSV file (e.g., with text columns). If CSV files are not visible, select 'All Files' in the file picker.</p>
        </div>

        <!-- Progress and File Info -->
        <div class="mb-4 flex justify-between items-center">
            <div>
                <span id="fileInfo" class="text-sm font-medium text-gray-600">No file loaded</span>
                <span id="progressCount" class="ml-4 text-sm font-medium text-gray-600">Annotated 0 of 0 items</span>
            </div>
            <div class="w-1/3">
                <div class="bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Data Display -->
        <div id="dataDisplay" class="bg-gray-100 p-5 rounded-lg mb-6 border">
            <p id="currentData" class="text-lg text-gray-800">Upload a CSV file to load data for annotation.</p>
            <p id="endOfFile" class="text-sm text-red-500 mt-2 hidden">End of file reached.</p>
        </div>

        <!-- Annotation Input -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Label:</label>
            <div id="labelsContainer" class="flex flex-wrap gap-4"></div>
            <div id="othersInput" class="mt-4 hidden">
                <label for="otherDetails" class="block text-sm font-medium text-gray-700">Additional Details:</label>
                <textarea id="otherDetails" rows="4" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter additional details for 'Others'..."></textarea>
            </div>
        </div>

        <!-- Controls -->
        <div class="flex justify-between mb-6">
            <button id="prevBtn" class="tooltip bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 disabled:opacity-50" disabled>
                Previous
                <span class="tooltip-text">Go to previous data item (←)</span>
            </button>
            <button id="saveBtn" class="tooltip bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50" disabled>
                Save Annotation
                <span class="tooltip-text">Save and go to next item (Enter)</span>
            </button>
            <button id="nextBtn" class="tooltip bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 disabled:opacity-50" disabled>
                Next Data
                <span class="tooltip-text">Go to next data item (→)</span>
            </button>
        </div>
        <p id="saveStatus" class="text-sm text-green-500 text-center hidden">Annotation saved!</p>

        <!-- Additional Controls -->
        <div class="flex justify-between mb-6">
            <button id="viewAnnotationsBtn" class="tooltip bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50" disabled>
                View Annotations
                <span class="tooltip-text">See all saved annotations</span>
            </button>
            <button id="undoBtn" class="tooltip bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 disabled:opacity-50" disabled>
                Undo Last
                <span class="tooltip-text">Revert last annotation (Ctrl+Z)</span>
            </button>
            <button id="resetBtn" class="tooltip bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50" disabled>
                Return to Start
                <span class="tooltip-text">Go to first data item</span>
            </button>
            <button id="settingsBtn" class="tooltip bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                Settings
                <span class="tooltip-text">Customize labels and column</span>
            </button>
            <button id="downloadBtn" class="tooltip bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 disabled:opacity-50" disabled>
                Download CSV
                <span class="tooltip-text">Download annotations as CSV</span>
            </button>
        </div>

        <!-- Google Sheets Instructions -->
        <p class="text-sm text-gray-600 mb-6">To share with Google Sheets: Download the CSV, then upload it to Google Drive and open it in Google Sheets, or use "File > Import" in Google Sheets.</p>

        <!-- Annotations Modal -->
        <div id="annotationsModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl max-h-[80vh] overflow-y-auto">
                <h2 class="text-lg font-semibold mb-4">Saved Annotations</h2>
                <ul id="annotationsList" class="list-disc pl-5 mb-4"></ul>
                <button id="closeModalBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Close</button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                <h2 class="text-lg font-semibold mb-4">Settings</h2>
                <div class="mb-4">
                    <label for="columnSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Column for Annotation:</label>
                    <select id="columnSelect" class="w-full p-2 border rounded-lg"></select>
                </div>
                <h3 class="text-sm font-medium text-gray-700 mb-2">Customize Labels</h3>
                <div id="labelsList" class="mb-4"></div>
                <div class="flex gap-2">
                    <input id="newLabelInput" type="text" class="w-full p-2 border rounded-lg" placeholder="Enter new label">
                    <button id="addLabelBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add</button>
                </div>
                <p id="labelError" class="text-sm text-red-500 mt-2 hidden">Label must be non-empty and unique.</p>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="closeSettingsBtn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">Close</button>
                    <button id="saveSettingsBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data and annotations
        let dataItems = []; // 2D array for all columns
        let annotations = [];
        let currentIndex = -1;
        let currentFileName = '';
        let lastAnnotation = null;
        let selectedColumn = 0;
        let columnHeaders = [];
        let labels = [
            { name: 'Positive', color: 'bg-green-100 text-green-800 hover:bg-green-200' },
            { name: 'Neutral', color: 'bg-gray-100 text-gray-800 hover:bg-gray-200' },
            { name: 'Negative', color: 'bg-red-100 text-red-800 hover:bg-red-200' },
            { name: 'Not Applicable', color: 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200' },
            { name: 'Others', color: 'bg-blue-100 text-blue-800 hover:bg-blue-200' }
        ];
        let tempLabels = [...labels];
        let tempColumn = selectedColumn;

        // DOM elements
        const csvUpload = document.getElementById('csvUpload');
        const uploadStatus = document.getElementById('uploadStatus');
        const fileInfo = document.getElementById('fileInfo');
        const progressCount = document.getElementById('progressCount');
        const progressBar = document.getElementById('progressBar');
        const dataDisplay = document.getElementById('currentData');
        const endOfFile = document.getElementById('endOfFile');
        const labelsContainer = document.getElementById('labelsContainer');
        const othersInput = document.getElementById('othersInput');
        const otherDetails = document.getElementById('otherDetails');
        const prevBtn = document.getElementById('prevBtn');
        const saveBtn = document.getElementById('saveBtn');
        const nextBtn = document.getElementById('nextBtn');
        const saveStatus = document.getElementById('saveStatus');
        const viewAnnotationsBtn = document.getElementById('viewAnnotationsBtn');
        const undoBtn = document.getElementById('undoBtn');
        const resetBtn = document.getElementById('resetBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const annotationsModal = document.getElementById('annotationsModal');
        const annotationsList = document.getElementById('annotationsList');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const settingsModal = document.getElementById('settingsModal');
        const columnSelect = document.getElementById('columnSelect');
        const labelsList = document.getElementById('labelsList');
        const newLabelInput = document.getElementById('newLabelInput');
        const addLabelBtn = document.getElementById('addLabelBtn');
        const labelError = document.getElementById('labelError');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');

        // Render labels
        function renderLabels() {
            labelsContainer.innerHTML = '';
            labels.forEach((label, index) => {
                const labelElement = document.createElement('label');
                labelElement.className = 'flex items-center';
                labelElement.innerHTML = `
                    <input type="radio" name="label" value="${label.name}" class="hidden label-btn" ${label.name === 'Neutral' ? 'checked' : ''}>
                    <span class="label-text ${label.color} px-4 py-2 rounded-lg cursor-pointer">${label.name}</span>
                `;
                labelsContainer.appendChild(labelElement);
            });
            document.querySelectorAll('input[name="label"]').forEach(input => {
                input.addEventListener('change', () => {
                    othersInput.classList.toggle('hidden', input.value !== 'Others');
                    if (input.value !== 'Others') otherDetails.value = '';
                });
            });
        }

        // Render settings labels
        function renderSettingsLabels() {
            labelsList.innerHTML = '';
            tempLabels.forEach((label, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center mb-2';
                div.innerHTML = `
                    <span class="text-gray-700">${label.name}</span>
                    <button class="text-red-500 hover:text-red-700" data-index="${index}">Remove</button>
                `;
                labelsList.appendChild(div);
            });
            labelsList.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const index = parseInt(btn.dataset.index);
                    tempLabels.splice(index, 1);
                    renderSettingsLabels();
                });
            });
        }

        // Render column selector
        function renderColumnSelector() {
            columnSelect.innerHTML = '';
            columnHeaders.forEach((header, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = header || `Column ${index + 1}`;
                if (index === tempColumn) option.selected = true;
                columnSelect.appendChild(option);
            });
        }

        // Handle CSV file upload
        csvUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                uploadStatus.textContent = 'No file selected.';
                console.error('No file selected.');
                alert('Please select a file.');
                return;
            }

            currentFileName = file.name;
            uploadStatus.textContent = `Selected file: ${file.name}`;
            fileInfo.textContent = `File: ${file.name}`;
            console.log('Selected file:', file.name, 'Size:', file.size, 'Type:', file.type);

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const text = e.target.result;
                    console.log('Raw CSV content:', text);
                    const { headers, data } = parseCSV(text);
                    console.log('Parsed headers:', headers);
                    console.log('Parsed data:', data);
                    if (data.length === 0) {
                        uploadStatus.textContent = 'No valid data found in CSV.';
                        console.warn('No valid data found in CSV.');
                        alert('No valid data found in CSV. Ensure it has at least one row of data.');
                        fileInfo.textContent = 'No file loaded';
                        return;
                    }
                    columnHeaders = headers;
                    dataItems = data;
                    currentIndex = -1;
                    annotations = new Array(dataItems.length).fill(null);
                    lastAnnotation = null;
                    selectedColumn = 0;
                    uploadStatus.textContent = `Loaded ${dataItems.length} data items from ${file.name} with ${columnHeaders.length} columns.`;
                    updateProgress();
                    renderColumnSelector();
                    loadNextData();
                } catch (error) {
                    uploadStatus.textContent = 'Error parsing CSV file.';
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing CSV file. Check console for details.');
                    fileInfo.textContent = 'No file loaded';
                }
            };
            reader.onerror = () => {
                uploadStatus.textContent = 'Error reading file.';
                console.error('FileReader error:', reader.error);
                alert('Error reading file.');
                fileInfo.textContent = 'No file loaded';
            };
            reader.readAsText(file);
        });

        // Parse CSV into headers and data
        function parseCSV(text) {
            const rows = text.split('\n').map(row => row.trim()).filter(row => row);
            if (rows.length <= 0) return { headers: [], data: [] };
            const headers = rows[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.replace(/^"|"$/g, '').trim());
            const data = rows.slice(1).map(row => {
                const columns = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                return columns;
            }).filter(row => row.some(cell => cell)); // Remove empty rows
            return { headers, data };
        }

        // Load next data item
        function loadNextData() {
            if (currentIndex < dataItems.length - 1) {
                currentIndex++;
                dataDisplay.textContent = dataItems[currentIndex][selectedColumn] || 'No data available.';
                endOfFile.classList.toggle('hidden', currentIndex < dataItems.length - 1);
                resetInputs();
                updateButtons();
            }
        }

        // Load previous data item
        function loadPrevData() {
            if (currentIndex > 0) {
                currentIndex--;
                dataDisplay.textContent = dataItems[currentIndex][selectedColumn] || 'No data available.';
                endOfFile.classList.add('hidden');
                resetInputs();
                updateButtons();
            }
        }

        // Reset to start
        function resetToStart() {
            currentIndex = -1;
            loadNextData();
        }

        // Reset input fields
        function resetInputs() {
            document.querySelectorAll('input[name="label"]').forEach(input => {
                input.checked = input.value === 'Neutral';
            });
            othersInput.classList.add('hidden');
            otherDetails.value = '';
        }

        // Update button states
        function updateButtons() {
            prevBtn.disabled = currentIndex <= 0 || dataItems.length === 0;
            nextBtn.disabled = currentIndex >= dataItems.length - 1 || dataItems.length === 0;
            saveBtn.disabled = dataItems.length === 0;
            viewAnnotationsBtn.disabled = annotations.every(a => a === null);
            undoBtn.disabled = lastAnnotation === null || dataItems.length === 0;
            resetBtn.disabled = dataItems.length === 0;
            downloadBtn.disabled = annotations.every(a => a === null);
        }

        // Update progress bar and count
        function updateProgress() {
            const annotatedCount = annotations.filter(a => a !== null).length;
            const totalCount = dataItems.length;
            const percentage = totalCount > 0 ? (annotatedCount / totalCount) * 100 : 0;
            progressCount.textContent = `Annotated ${annotatedCount} of ${totalCount} items`;
            progressBar.style.width = `${percentage}%`;
        }

        // Save annotation and advance
        function saveAnnotation() {
            const selectedLabel = document.querySelector('input[name="label"]:checked').value;
            const otherText = selectedLabel === 'Others' ? otherDetails.value.trim() : '';
            if (currentIndex >= 0) {
                lastAnnotation = { index: currentIndex, annotation: annotations[currentIndex] };
                annotations[currentIndex] = { label: selectedLabel, details: otherText };
                updateProgress();
                saveStatus.classList.remove('hidden');
                setTimeout(() => saveStatus.classList.add('hidden'), 2000);
                if (currentIndex < dataItems.length - 1) {
                    loadNextData();
                } else {
                    endOfFile.classList.remove('hidden');
                    resetInputs();
                    updateButtons();
                }
            }
        }

        // Undo last annotation
        function undoAnnotation() {
            if (lastAnnotation) {
                annotations[lastAnnotation.index] = lastAnnotation.annotation;
                currentIndex = lastAnnotation.index;
                dataDisplay.textContent = dataItems[currentIndex][selectedColumn] || 'No data available.';
                endOfFile.classList.toggle('hidden', currentIndex < dataItems.length - 1);
                lastAnnotation = null;
                updateProgress();
                resetInputs();
                updateButtons();
            }
        }

        // Show annotations in modal
        function showAnnotations() {
            annotationsList.innerHTML = '';
            annotations.forEach((annotation, index) => {
                if (annotation) {
                    const li = document.createElement('li');
                    const details = annotation.details ? ` (${annotation.details})` : '';
                    li.textContent = `Data: "${dataItems[index][selectedColumn]}" - Label: ${annotation.label}${details}`;
                    annotationsList.appendChild(li);
                }
            });
            annotationsModal.classList.remove('hidden');
        }

        // Show settings modal
        function showSettings() {
            tempLabels = [...labels];
            tempColumn = selectedColumn;
            renderSettingsLabels();
            renderColumnSelector();
            settingsModal.classList.remove('hidden');
        }

        // Add new label
        function addLabel() {
            const newLabel = newLabelInput.value.trim();
            if (!newLabel || tempLabels.some(label => label.name.toLowerCase() === newLabel.toLowerCase())) {
                labelError.classList.remove('hidden');
                return;
            }
            labelError.classList.add('hidden');
            tempLabels.push({ name: newLabel, color: 'bg-blue-100 text-blue-800 hover:bg-blue-200' });
            newLabelInput.value = '';
            renderSettingsLabels();
        }

        // Save settings
        function saveSettings() {
            if (tempLabels.length === 0) {
                labelError.textContent = 'At least one label is required.';
                labelError.classList.remove('hidden');
                return;
            }
            const newColumn = parseInt(columnSelect.value);
            if (newColumn !== selectedColumn && annotations.some(a => a !== null)) {
                if (confirm('Changing the column will reset annotations. Do you want to download the current annotations first?')) {
                    downloadAnnotations();
                }
                annotations = new Array(dataItems.length).fill(null);
                lastAnnotation = null;
                currentIndex = -1;
            }
            labels = [...tempLabels];
            selectedColumn = newColumn;
            renderLabels();
            settingsModal.classList.add('hidden');
            labelError.classList.add('hidden');
            updateProgress();
            loadNextData();
        }

        // Download annotations as CSV
        function downloadAnnotations() {
            const csvRows = ['"Data","Label","Details"'];
            dataItems.forEach((row, index) => {
                if (annotations[index]) {
                    const data = row[selectedColumn];
                    const label = annotations[index].label;
                    const details = annotations[index].details ? `"${annotations[index].details.replace(/"/g, '""')}"` : '';
                    csvRows.push(`"${data.replace(/"/g, '""')}","${label}",${details}`);
                }
            });
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `annotations_column_${columnHeaders[selectedColumn] || selectedColumn + 1}.csv`;
            link.click();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !saveBtn.disabled && !settingsModal.classList.contains('hidden') === false) {
                saveAnnotation();
            } else if (e.key === 'ArrowLeft' && !prevBtn.disabled) {
                loadPrevData();
            } else if (e.key === 'ArrowRight' && !nextBtn.disabled) {
                loadNextData();
            } else if (e.ctrlKey && e.key === 'z' && !undoBtn.disabled) {
                undoAnnotation();
            } else if (e.key >= '1' && e.key <= '5' && dataItems.length > 0) {
                const index = parseInt(e.key) - 1;
                if (index < labels.length) {
                    document.querySelector(`input[value="${labels[index].name}"]`).checked = true;
                    othersInput.classList.toggle('hidden', labels[index].name !== 'Others');
                    if (labels[index].name !== 'Others') otherDetails.value = '';
                }
            }
        });

        // Event listeners
        nextBtn.addEventListener('click', loadNextData);
        prevBtn.addEventListener('click', loadPrevData);
        saveBtn.addEventListener('click', saveAnnotation);
        viewAnnotationsBtn.addEventListener('click', showAnnotations);
        undoBtn.addEventListener('click', undoAnnotation);
        resetBtn.addEventListener('click', resetToStart);
        settingsBtn.addEventListener('click', showSettings);
        addLabelBtn.addEventListener('click', addLabel);
        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('hidden');
            labelError.classList.add('hidden');
        });
        saveSettingsBtn.addEventListener('click', saveSettings);
        downloadBtn.addEventListener('click', downloadAnnotations);
        closeModalBtn.addEventListener('click', () => annotationsModal.classList.add('hidden'));

        // Initialize
        renderLabels();
        updateButtons();
    </script>
</body>
</html>
